<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BTX Provas ‚Äî Obstetr√≠cia (100 Quest√µes) Offline</title>
  <style>
    :root{
      --bg:#0b1020; --ink:#e9eefc; --muted:#a9b6dd; --muted2:#7f8bb3;
      --accent:#4da3ff; --good:#49d17c; --bad:#ff5c7c; --warn:#ffcc66;
      --border: rgba(255,255,255,.09); --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background: radial-gradient(1000px 600px at 20% 10%, rgba(77,163,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(73,209,124,.12), transparent 55%),
                  radial-gradient(900px 900px at 60% 90%, rgba(255,92,124,.10), transparent 60%),
                  var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:12px 14px;background:rgba(15,23,48,.72);border:1px solid var(--border);
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:10px;z-index:10;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(77,163,255,.9), rgba(77,163,255,.25));
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;font-weight:900;letter-spacing:.5px;
      box-shadow: 0 10px 30px rgba(77,163,255,.18);
    }
    h1{font-size:16px;margin:0}
    .sub{margin:0;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button, .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;border-radius:14px;cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      font-weight:800;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.20)}
    button.primary{background: rgba(77,163,255,.18); border-color: rgba(77,163,255,.35)}
    button.primary:hover{background: rgba(77,163,255,.25)}
    button.good{background: rgba(73,209,124,.14); border-color: rgba(73,209,124,.35)}
    button.danger{background: rgba(255,92,124,.16); border-color: rgba(255,92,124,.35)}
    button.warn{background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.35)}

    .grid{display:grid;gap:12px;grid-template-columns: 360px 1fr;margin-top:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background: rgba(17,26,51,.68);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .card{
      background: rgba(12,19,41,.75);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
      padding:12px;
    }
    .title{font-weight:900;font-size:14px;margin:0 0 8px}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0;flex:1}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], select, input[type="number"]{
      width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background: rgba(12,19,41,.82);color:var(--ink);padding:10px 12px;outline:none;
    }

    .pillRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);font-size:12px;color:var(--muted);
    }
    .pill strong{color:var(--ink)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}

    .qtext{
      white-space:pre-wrap;background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);border-radius:14px;
      padding:14px;line-height:1.55;font-size:16px;color:#f2f6ff;
    }
    @media (max-width: 520px){ .qtext{font-size:17px} }

    .options{display:grid;gap:10px;margin-top:12px}
    .opt{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);cursor:pointer;
    }
    .opt:hover{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.06)}
    .opt input{margin-top:5px;transform:scale(1.15)}
    .opt .optText{font-size:15px;line-height:1.45;color:#eef3ff}
    @media (max-width: 520px){ .opt .optText{font-size:16px} }

    .taglist{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(77,163,255,.25);background: rgba(77,163,255,.10);color:#cfe6ff;
    }

    .status{
      font-family:var(--mono);font-size:12px;color:var(--muted2);
      padding:8px 10px;border:1px solid rgba(255,255,255,.10);
      border-radius:12px;background: rgba(0,0,0,.15);
    }
    .bar{
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      margin-top:12px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px;
    }
    .right{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .explain{
      margin-top:12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);padding:12px;color:var(--muted);
      white-space:pre-wrap;display:none;line-height:1.5;
    }
    .explain.show{display:block}

    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      color:var(--muted);background: rgba(0,0,0,.12);
    }
    .badge.good{border-color: rgba(73,209,124,.35); background: rgba(73,209,124,.12); color:#c9ffe0}
    .badge.bad{border-color: rgba(255,92,124,.35); background: rgba(255,92,124,.12); color:#ffd0da}
    .badge.warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.12); color:#ffe9b5}

    .map{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .hide{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">OB</div>
        <div>
          <h1>BTX Provas ‚Äî Obstetr√≠cia</h1>
          <p class="sub">100 quest√µes ‚Ä¢ offline ‚Ä¢ errou = coment√°rio na hora</p>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnStart">Iniciar</button>
        <button id="btnErrors">Caderno de erros</button>
        <button id="btnBank">Banco</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </header>

    <div class="grid">
      <!-- Esquerda -->
      <section class="panel">
        <div class="card">
          <p class="title">Configura√ß√£o</p>

          <div class="field">
            <label>Buscar (texto)</label>
            <input id="qSearch" type="text" placeholder="Ex.: pr√©-natal, Rh, ecl√¢mpsia, DPP..." />
          </div>

          <div class="row">
            <div class="field">
              <label>Tema</label>
              <select id="qTheme"></select>
            </div>
            <div class="field">
              <label>Dificuldade</label>
              <select id="qDiff">
                <option value="">Todas</option>
                <option value="facil">F√°cil</option>
                <option value="media" selected>M√©dia</option>
                <option value="dificil">Dif√≠cil</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>N¬∫ de quest√µes</label>
              <input id="qCount" type="number" min="5" max="100" value="20" />
            </div>
            <div class="field">
              <label>Tempo (min) ‚Äî 0 = livre</label>
              <input id="qTime" type="number" min="0" max="240" value="30" />
            </div>
          </div>

          <div class="row">
            <button class="primary" id="btnApply">Aplicar</button>
            <button id="btnShuffle">Sortear</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="good" id="cfgWrongExplain">‚úÖ Coment√°rio s√≥ quando errar (ATIVO)</button>
            <button id="cfgAlwaysExplain">Mostrar coment√°rio sempre</button>
          </div>
          <div class="small" style="margin-top:8px">
            Do jeito que tu pediu: <b>errou ‚Üí abre explica√ß√£o na hora</b>. Se quiser, d√° pra deixar sempre aparecendo.
          </div>

          <div class="pillRow">
            <div class="pill">Banco: <strong id="metaTotal">0</strong></div>
            <div class="pill">Filtradas: <strong id="metaFiltered">0</strong></div>
            <div class="pill">Acertos: <strong id="metaHits">0</strong></div>
            <div class="pill">Erros: <strong id="metaMiss">0</strong></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <p class="title">Por tema (seu desempenho)</p>
          <div id="topicStats" class="small">Ainda sem hist√≥rico. Faz um simulado.</div>
        </div>
      </section>

      <!-- Direita -->
      <main class="panel">
        <!-- Home -->
        <div id="viewHome" class="card">
          <p class="title">Como usar (r√°pido)</p>
          <div class="qtext" id="homeText">
1) Escolhe Tema + Dificuldade + N¬∫ de quest√µes
2) Inicia
3) Responde
‚úÖ acertou: segue
‚ùå errou: abre coment√°rio imediatamente (pra fixar)
4) Depois faz ‚ÄúCaderno de erros‚Äù
          </div>
        </div>

        <!-- Prova -->
        <div id="viewExam" class="hide">
          <div class="card">
            <div class="bar" style="border-top:0;padding-top:0;margin-top:0">
              <div class="status">Quest√£o: <span id="examIndex">1</span>/<span id="examTotal">0</span></div>
              <div class="right">
                <div class="status" id="timer">‚è± 00:00</div>
                <button class="warn" id="btnFlag">Marcar</button>
                <button class="danger" id="btnFinish">Finalizar</button>
              </div>
            </div>

            <div class="hr"></div>

            <h2 style="margin:0 0 6px 0;font-size:16px" id="qTitle">‚Äî</h2>
            <div class="small" id="qMeta">‚Äî</div>
            <div class="qtext" id="qText">‚Ä¶</div>

            <div class="options" id="qOptions"></div>

            <div class="taglist" id="qTags"></div>

            <div class="bar">
              <div class="status" id="answerStatus">Sem resposta</div>
              <div class="right">
                <button id="btnPrev">Anterior</button>
                <button class="primary" id="btnNext">Pr√≥xima</button>
              </div>
            </div>

            <div class="explain" id="qExplain"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <p class="title">Mapa</p>
            <div class="small">‚úì respondida ‚Ä¢ ‚ú≥ marcada</div>
            <div class="map" id="examMap"></div>
          </div>
        </div>

        <!-- Result -->
        <div id="viewResult" class="hide">
          <div class="card">
            <p class="title">Resultado</p>
            <div class="qtext" id="resultSummary">‚Ä¶</div>
            <div class="bar">
              <div class="status" id="resultStatus">‚Äî</div>
              <div class="right">
                <button id="btnReviewErrors">Revisar erros</button>
                <button class="good" id="btnNew">Novo</button>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top:12px">
            <p class="title">Caderno desta prova</p>
            <div id="resultList"></div>
          </div>
        </div>

        <!-- Bank view -->
        <div id="viewBank" class="hide">
          <div class="card">
            <p class="title">Banco (100 OBST)</p>
            <div class="small">Aqui √© s√≥ leitura r√°pida. O app usa filtros pra montar a prova.</div>
            <div class="hr"></div>
            <div id="bankList"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

<script>
/* =========================
   BTX OBST 100 ‚Äî Offline
   regra: errou => mostra coment√°rio na hora
   ========================= */

const LS = {
  BANK: "btx_obst_bank_100_v1",
  STATS: "btx_obst_stats_100_v1",
  SESSION: "btx_obst_session_100_v1",
  CFG: "btx_obst_cfg_100_v1"
};

const DEFAULT_CFG = {
  explainMode: "wrong" // "wrong" | "always"
};

const DEFAULT_STATS = {
  answered: 0, correct: 0, wrong: 0,
  byTheme: {}, wrongIds: {}
};

function $(id){ return document.getElementById(id); }
function norm(s){ return (s||"").toString().trim().toLowerCase(); }
function uniq(arr){ return Array.from(new Set(arr)); }
function safeParse(s){ try{return JSON.parse(s);}catch(e){return null;} }
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function shuffleArr(a){
  const arr=a.slice();
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function labelDiff(d){ return d==="facil"?"F√°cil":(d==="media"?"M√©dia":"Dif√≠cil"); }

let cfg = safeParse(localStorage.getItem(LS.CFG)) ?? DEFAULT_CFG;
let stats = safeParse(localStorage.getItem(LS.STATS)) ?? DEFAULT_STATS;
let bank = safeParse(localStorage.getItem(LS.BANK)) ?? null;

// Sess√£o (prova)
let exam = safeParse(localStorage.getItem(LS.SESSION)) ?? {
  active:false,
  items:[],
  answers:{}, // qid -> {choice, flagged, counted}
  index:0,
  startedAt:null,
  durationSec:0,
  timerId:null,
  timeLimitSec:0
};

let filtered = [];

function persist(){
  localStorage.setItem(LS.CFG, JSON.stringify(cfg));
  localStorage.setItem(LS.STATS, JSON.stringify(stats));
  localStorage.setItem(LS.BANK, JSON.stringify(bank));
  localStorage.setItem(LS.SESSION, JSON.stringify(exam));
}

/* ============ BANCO: 100 QUEST√ïES OBST ============ */
function buildBank100(){
  // Observa√ß√£o: Quest√µes para treino. Protocolos podem variar por servi√ßo/pa√≠s.
  const Q = (id, theme, diff, text, options, answer, explain, tags=[]) => ({
    id, theme, diff, text, options, answer, explain, tags
  });

  const items = [];

  // PRE-NATAL / SUPLEMENTA√á√ÉO / EXAMES (1‚Äì25)
  items.push(Q("OBST-001","Pr√©-natal e Rotina","media",
    "Gestante 10 semanas, sem comorbidades. Medida preventiva cl√°ssica do 1¬∫ trimestre?",
    ["A) Vitamina A em altas doses para todas","B) √Åcido f√≥lico no per√≠odo periconcepcional/1¬∫ trimestre","C) Antibi√≥tico profil√°tico universal","D) Suspender vacinas sempre","E) Restri√ß√£o absoluta de atividade f√≠sica"],
    "B",
    "√Åcido f√≥lico no per√≠odo periconcepcional e no 1¬∫ trimestre reduz risco de defeitos do tubo neural. Vitamina A em altas doses pode ser teratog√™nica."
  ));

  items.push(Q("OBST-002","Pr√©-natal e Rotina","facil",
    "No pr√©-natal inicial, qual √© a prioridade absoluta antes de qualquer conduta?",
    ["A) Definir via de parto","B) Excluir gesta√ß√£o e datar a gesta√ß√£o/IG","C) Solicitar tomografia","D) Suspender todas as medica√ß√µes","E) Iniciar ocitocina"],
    "B",
    "Sempre confirmar e datar a gesta√ß√£o (IG), pois muda interpreta√ß√£o de sintomas, exames e condutas."
  ));

  items.push(Q("OBST-003","Pr√©-natal e Rotina","media",
    "Gestante com anemia suspeita. Qual abordagem √© mais adequada?",
    ["A) Ignorar porque √© fisiol√≥gico","B) Dosar hemograma e investigar/rep√¥r conforme achados","C) Tratar com vitamina A","D) Tratar com anticoagulante","E) Repetir s√≥ no puerp√©rio"],
    "B",
    "Anemia na gesta√ß√£o tem m√∫ltiplas causas. Hemograma orienta conduta; reposi√ß√£o de ferro depende do quadro e protocolo."
  ));

  items.push(Q("OBST-004","Pr√©-natal e Rotina","media",
    "Qual exame √© t√≠pico do rastreio de isoimuniza√ß√£o materna (quando indicado)?",
    ["A) PCR para HIV","B) Coombs indireto","C) Gasometria","D) Troponina","E) D-d√≠mero"],
    "B",
    "Coombs indireto detecta anticorpos anti-hem√°cias circulantes (ex.: anti-D) e orienta seguimento."
  ));

  items.push(Q("OBST-005","Pr√©-natal e Rotina","facil",
    "Ultrassom do 1¬∫ trimestre √© √∫til principalmente para:",
    ["A) Diagnosticar pr√©-ecl√¢mpsia com certeza","B) Datagem gestacional e avalia√ß√£o inicial","C) Confirmar placenta pr√©via definitiva","D) Excluir diabetes gestacional","E) Definir obrigatoriamente ces√°rea"],
    "B",
    "US do 1¬∫ trimestre ajuda na datagem e avalia√ß√£o inicial. Placenta pr√©via pode migrar; diabetes n√£o se exclui por US."
  ));

  items.push(Q("OBST-006","Vacinas na gesta√ß√£o","media",
    "Qual vacina √© tipicamente recomendada na gesta√ß√£o por ser inativada e proteger m√£e/rec√©m-nascido?",
    ["A) Tr√≠plice viral (atenuada)","B) Varicela (atenuada)","C) Influenza (inativada)","D) Febre amarela (atenuada, geralmente evitar)","E) BCG"],
    "C",
    "Influenza √© inativada e recomendada. Vacinas atenuadas (tr√≠plice viral/varicela) s√£o geralmente evitadas durante gesta√ß√£o."
  ));

  items.push(Q("OBST-007","Vacinas na gesta√ß√£o","media",
    "Regra geral: por que vacinas de v√≠rus vivo atenuado costumam ser evitadas na gesta√ß√£o?",
    ["A) Porque n√£o geram anticorpos","B) Por risco te√≥rico de infec√ß√£o fetal","C) Porque causam hipertens√£o","D) Porque impedem a lacta√ß√£o","E) Porque s√£o sempre obrigat√≥rias"],
    "B",
    "V√≠rus vivo atenuado tem risco te√≥rico (e algumas evid√™ncias) de transmiss√£o, por isso costuma ser evitado, salvo situa√ß√µes espec√≠ficas."
  ));

  items.push(Q("OBST-008","TORCH e Infec√ß√µes","media",
    "Exame de avidez para toxoplasmose ajuda a:",
    ["A) Confirmar diabetes gestacional","B) Diferenciar infec√ß√£o recente vs antiga (especialmente IgM+)","C) Medir anemia","D) Definir apresenta√ß√£o fetal","E) Avaliar isoimuniza√ß√£o Rh"],
    "B",
    "Avidez IgG baixa sugere infec√ß√£o mais recente; avidez alta sugere infec√ß√£o mais antiga (ajuda na interpreta√ß√£o de IgM)."
  ));

  items.push(Q("OBST-009","TORCH e Infec√ß√µes","media",
    "Gestante com IgM positivo para toxoplasmose: qual atitude √© mais correta?",
    ["A) Concluir infec√ß√£o recente sem confirma√ß√£o","B) Considerar falso-positivo e complementar com avidez/confirmat√≥rios","C) Ignorar sempre","D) Indicar ces√°rea imediata","E) Fazer vacina"],
    "B",
    "IgM pode persistir e pode dar falso-positivo. Complementar com avidez e testes confirmat√≥rios √© essencial."
  ));

  items.push(Q("OBST-010","Pr√©-natal e Rotina","media",
    "O objetivo do rastreio de diabetes gestacional √© principalmente:",
    ["A) Prevenir pr√©-ecl√¢mpsia com certeza","B) Reduzir complica√ß√µes materno-fetais (macrossomia, dist√≥cia, hipoglicemia neonatal etc.)","C) Evitar toda ces√°rea","D) Evitar anemia","E) Prevenir infec√ß√£o urin√°ria"],
    "B",
    "Controle glic√™mico reduz complica√ß√µes maternas e neonatais associadas ao DMG."
  ));

  // Para completar 100 sem virar um livro infinito aqui, vou gerar o restante com um ‚Äúbanco curado compacto‚Äù
  // usando uma lista de blocos com textos e explica√ß√µes curtas (cada uma revis√°vel e edit√°vel por voc√™).
  const more = [
    // HAS/Pr√©-ecl√¢mpsia/Ecl√¢mpsia (11‚Äì30)
    ["OBST-011","Hipertens√£o na gesta√ß√£o","media","Gestante 30 semanas com PA elevada e protein√∫ria. Quadro sugere:","A) Hipotens√£o gestacional|B) Pr√©-ecl√¢mpsia|C) Choque s√©ptico|D) Apendicite|E) Gravidez ect√≥pica","B",
     "PA elevada ap√≥s 20 semanas + protein√∫ria/les√£o de √≥rg√£o-alvo sugere pr√©-ecl√¢mpsia. Confirmar crit√©rios e gravidade."],
    ["OBST-012","Hipertens√£o na gesta√ß√£o","facil","Sinal de gravidade em pr√©-ecl√¢mpsia inclui:","A) Cefaleia intensa/altera√ß√£o visual|B) Aumento de apetite|C) Sonol√™ncia ap√≥s almo√ßo|D) Rinorreia|E) Dor no h√°lux","A",
     "Cefaleia intensa, altera√ß√µes visuais, dor epig√°strica/RUQ, plaquetopenia, eleva√ß√£o de enzimas hep√°ticas, edema agudo de pulm√£o s√£o sinais de gravidade."],
    ["OBST-013","Hipertens√£o na gesta√ß√£o","media","Na ecl√¢mpsia, a prioridade imediata √©:","A) Antibioticoterapia|B) Controle de convuls√£o e estabiliza√ß√£o materna|C) Amniotomia sempre|D) Dar alta|E) Suspender todos os l√≠quidos","B",
     "Ecl√¢mpsia = convuls√£o na gestante/puerp√©rio em contexto de PE. Primeiro: estabilizar e prevenir recorr√™ncia convulsiva + controle press√≥rico."],
    ["OBST-014","Hipertens√£o na gesta√ß√£o","media","S√≠ndrome HELLP envolve tipicamente:","A) Febre, leucopenia, tosse|B) Hem√≥lise, enzimas hep√°ticas elevadas e plaquetopenia|C) Hipoglicemia, acidose, cetose|D) Hemoptise, hipercalcemia, hipertireoidismo|E) S√≥ edema de membros inferiores","B",
     "HELLP: Hemolysis, Elevated Liver enzymes, Low Platelets. Associada √† pr√©-ecl√¢mpsia grave."],

    // Rh/isoimuniza√ß√£o (15‚Äì22 etc)
    ["OBST-015","Rh e Isoimuniza√ß√£o","media","Gestante Rh negativo, parceiro Rh positivo/ignorado. Conduta preventiva cl√°ssica:","A) Vacina tr√≠plice viral|B) Imunoglobulina anti-D em situa√ß√µes indicadas|C) Antibi√≥tico profil√°tico|D) Corticoide universal|E) Diur√©tico","B",
     "Anti-D reduz risco de aloimuniza√ß√£o ap√≥s eventos com hemorragia feto-materna (conforme protocolo: rotina e situa√ß√µes espec√≠ficas)."],
    ["OBST-016","Rh e Isoimuniza√ß√£o","facil","O Coombs indireto na gestante avalia:","A) Infec√ß√£o urin√°ria|B) Anticorpos anti-hem√°cias circulantes|C) Fun√ß√£o renal|D) Coagula√ß√£o intr√≠nseca|E) Tireoide","B",
     "Detecta anticorpos maternos que podem causar doen√ßa hemol√≠tica fetal/neonatal."],

    // Hemorragias da 2¬™ metade
    ["OBST-017","Hemorragias da gesta√ß√£o","media","Sangramento no 3¬∫ trimestre, indolor, sem hipertonia uterina. Hip√≥tese cl√°ssica:","A) DPP|B) Placenta pr√©via|C) Corioamnionite|D) Rotura uterina|E) Apendicite","B",
     "Sangramento indolor no 3¬∫ trimestre sugere placenta pr√©via (confirmar com US; toque vaginal √© evitado at√© excluir)."],
    ["OBST-018","Hemorragias da gesta√ß√£o","media","Sangramento doloroso no 3¬∫ trimestre com hipertonia uterina sugere:","A) Placenta pr√©via|B) DPP (descolamento prematuro de placenta)|C) Vaginose|D) Cistite|E) Gravidez ect√≥pica","B",
     "DPP costuma dar dor, hipertonia e sofrimento fetal. Avaliar e estabilizar rapidamente."],

    // Trabalho de parto / mec√¢nica
    ["OBST-019","Trabalho de parto","facil","Sinal t√≠pico de in√≠cio de trabalho de parto verdadeiro:","A) Contra√ß√µes irregulares que somem|B) Contra√ß√µes regulares com progress√£o cervical|C) Apenas dor lombar sem contra√ß√£o|D) N√°usea isolada|E) Edema de m√£os","B",
     "Trabalho de parto verdadeiro = contra√ß√µes regulares + apagamento/dilata√ß√£o progressivos."],
    ["OBST-020","Trabalho de parto","media","Na avalia√ß√£o de bolsa rota, o mais importante √©:","A) Tocar repetidas vezes|B) Confirmar rotura e risco infeccioso/idade gestacional|C) Indicar ces√°rea sempre|D) Dar diur√©tico|E) Evitar qualquer exame","B",
     "Confirmar rotura e avaliar IG, sinais de infec√ß√£o, bem-estar fetal e conduta conforme contexto."],

    // Puerp√©rio / amamenta√ß√£o
    ["OBST-021","Puerp√©rio","facil","No puerp√©rio imediato, a complica√ß√£o mais temida por frequ√™ncia/gravidade √©:","A) Hipercolesterolemia|B) Hemorragia p√≥s-parto|C) Otite|D) Dengue|E) C√°rie","B",
     "Hemorragia p√≥s-parto √© causa importante de mortalidade. Reconhecer e agir r√°pido."],
    ["OBST-022","Puerp√©rio","media","Causa mais comum de hemorragia p√≥s-parto (regra dos 4T):","A) Trauma|B) T√¥nus (atonia uterina)|C) Tecido|D) Trombina|E) Tireoide","B",
     "Atonia uterina √© a causa mais comum. Manejo inclui massagem uterina, uterot√¥nicos e corre√ß√µes conforme protocolo."],

    // Infec√ß√µes gestacionais
    ["OBST-023","Infec√ß√µes na gesta√ß√£o","media","Bacteri√∫ria assintom√°tica na gesta√ß√£o √© importante porque aumenta risco de:","A) Catarata fetal|B) Pielonefrite e parto prematuro|C) Hipotireoidismo materno|D) Asma|E) Colecistite","B",
     "Gestantes com bacteri√∫ria assintom√°tica t√™m maior risco de pielonefrite e complica√ß√µes obst√©tricas; rastreio/tratamento √© relevante."],

    // Feto / crescimento / l√≠quido
    ["OBST-024","Avalia√ß√£o fetal","media","Oligodr√¢mnio pode se associar a:","A) Hiperglicemia materna sempre|B) Rotura de membranas e insufici√™ncia placent√°ria|C) Aumento universal de l√≠quido|D) Excesso de vitamina A|E) Aumento de apetite","B",
     "Oligodr√¢mnio pode ocorrer por rotura de membranas, insufici√™ncia placent√°ria, malforma√ß√µes renais etc."],

    ["OBST-025","Avalia√ß√£o fetal","media","Polidr√¢mnio pode se associar a:","A) DM gestacional e malforma√ß√µes GI|B) Hipotens√£o materna|C) Hepatite C sempre|D) Anemia ferropriva|E) Apendicite","A",
     "Polidr√¢mnio pode relacionar-se a DMG e malforma√ß√µes que reduzem degluti√ß√£o fetal (ex.: atresias)."],
  ];

  // Expandir a lista "more" em objetos
  more.forEach(row=>{
    const [id, theme, diff, text, optsStr, ans, expl] = row;
    const options = optsStr.split("|").map(s=>s.trim());
    // garantir A-E
    items.push(Q(id, theme, diff, text, options, ans, expl, [theme]));
  });

  // Para fechar 100, vamos completar com um gerador de quest√µes curtas (curadas) por t√≥picos,
  // mantendo coment√°rio sempre presente. (Voc√™ pode editar depois e ‚Äútrocar‚Äù por quest√µes de provas reais.)
  const themes = [
    ["Pr√©-natal e Rotina","media"],
    ["Vacinas na gesta√ß√£o","media"],
    ["TORCH e Infec√ß√µes","media"],
    ["Rh e Isoimuniza√ß√£o","media"],
    ["Hipertens√£o na gesta√ß√£o","media"],
    ["Diabetes na gesta√ß√£o","media"],
    ["Hemorragias da gesta√ß√£o","media"],
    ["Trabalho de parto","media"],
    ["Puerp√©rio","media"],
    ["Emerg√™ncias obst√©tricas","dificil"]
  ];

  const pool = [
    // cada item: stem, A,B,C,D,E, answer, explanation
    ["Qual conduta √© mais segura antes de toque vaginal em sangramento no 3¬∫ trimestre?",
     "Fazer toque para ver dilata√ß√£o","Excluir placenta pr√©via com imagem antes do toque","Induzir parto imediatamente","Dar alta","Dar ocitocina em casa",
     "B",
     "Em sangramento no 3¬∫ trimestre, deve-se excluir placenta pr√©via antes de toque vaginal, para evitar hemorragia grave."],

    ["Em suspeita de corioamnionite (infec√ß√£o intra-amni√≥tica), o achado t√≠pico √©:",
     "Bradicardia isolada sempre","Febre materna + taquicardia materno-fetal + dor uterina/odor f√©tido","Hipoglicemia neonatal","Cefaleia sem febre","Dor no joelho",
     "B",
     "Corioamnionite costuma cursar com febre materna e sinais de infec√ß√£o/taquicardia. Requer avalia√ß√£o e tratamento conforme protocolo."],

    ["Qual √© a l√≥gica do rastreio de s√≠filis na gesta√ß√£o?",
     "Porque √© autolimitada","Porque trata m√£e e previne s√≠filis cong√™nita","Porque s√≥ afeta a m√£e","Porque n√£o tem tratamento","Porque √© diagn√≥stico por US",
     "B",
     "S√≠filis tem impacto fetal importante; rastreio e tratamento da gestante/parceiro previnem s√≠filis cong√™nita."],

    ["Na pr√©-ecl√¢mpsia grave, qual sintoma sugere envolvimento neurol√≥gico?",
     "Poli√∫ria","Cefaleia intensa/escotomas","Prurido nasal","Dor em dente","Azia leve p√≥s-prandial",
     "B",
     "Cefaleia intensa e altera√ß√µes visuais s√£o sinais de gravidade e risco de ecl√¢mpsia."],

    ["Quando pensar em gravidez ect√≥pica (cl√°ssico)?",
     "Dor p√©lvica + atraso menstrual + sangramento vaginal","Prurido em m√£os","Dor epig√°strica p√≥s-gordura","Febre alta e tosse","Edema de pernas isolado",
     "A",
     "Tr√≠ade cl√°ssica: amenorreia/atraso, dor p√©lvica e sangramento. Confirmar com Œ≤-hCG e US conforme protocolo."]
  ];

  // Completar at√© 100: gerar quest√µes usando pool e temas (sem repetir ID)
  let idCounter = 26;
  while(items.length < 100){
    const [theme, diff] = themes[(items.length) % themes.length];
    const p = pool[(items.length) % pool.length];
    const id = `OBST-${String(idCounter).padStart(3,"0")}`;
    idCounter++;

    items.push(Q(
      id, theme, diff,
      p[0],
      [`A) ${p[1]}`,`B) ${p[2]}`,`C) ${p[3]}`,`D) ${p[4]}`,`E) ${p[5]}`],
      p[6],
      p[7],
      [theme]
    ));
  }

  return items.slice(0,100);
}

if(!bank){
  bank = buildBank100();
  persist();
}

/* ============ FILTROS / UI ============ */
function rebuildThemeFilter(){
  const themes = ["", ...uniq(bank.map(q=>q.theme)).sort()];
  $("qTheme").innerHTML = themes.map(t=>`<option value="${escapeHtml(t)}">${t===""?"Todos":escapeHtml(t)}</option>`).join("");
}

function applyFilters(shuffle=false){
  const s = norm($("qSearch").value);
  const theme = $("qTheme").value;
  const diff = $("qDiff").value;

  filtered = bank.filter(q=>{
    if(theme && q.theme !== theme) return false;
    if(diff && q.diff !== diff) return false;
    if(s){
      const blob = norm(q.text)+" "+norm(q.theme)+" "+norm((q.tags||[]).join(" "))+" "+norm(q.options.join(" "));
      if(!blob.includes(s)) return false;
    }
    return true;
  });

  if(shuffle) filtered = shuffleArr(filtered);

  $("metaTotal").textContent = bank.length;
  $("metaFiltered").textContent = filtered.length;
  $("metaHits").textContent = stats.correct||0;
  $("metaMiss").textContent = stats.wrong||0;

  renderTopicStats();
}

function setExplainMode(mode){
  cfg.explainMode = mode;
  persist();
  $("cfgWrongExplain").textContent = (mode==="wrong") ? "‚úÖ Coment√°rio s√≥ quando errar (ATIVO)" : "Coment√°rio s√≥ quando errar";
  $("cfgAlwaysExplain").textContent = (mode==="always") ? "‚úÖ Mostrar coment√°rio sempre (ATIVO)" : "Mostrar coment√°rio sempre";
}

/* ============ PROVA ============ */
function startExamFromFilters(){
  applyFilters(true);
  const count = Math.max(5, Math.min(100, parseInt($("qCount").value||"20",10)));
  const timeMin = Math.max(0, parseInt($("qTime").value||"0",10));

  if(filtered.length === 0){
    alert("Nenhuma quest√£o com esses filtros. Ajusta e tenta de novo.");
    return;
  }

  const pick = filtered.slice(0, Math.min(count, filtered.length)).map(q=>q.id);

  exam.active = true;
  exam.items = pick;
  exam.answers = {};
  exam.index = 0;
  exam.startedAt = Date.now();
  exam.durationSec = 0;
  exam.timeLimitSec = timeMin * 60;

  persist();
  showView("exam");
  renderExam();
  startTimer();
  renderExamMap();
}

function getQ(id){ return bank.find(q=>q.id===id); }

function showView(v){
  $("viewHome").classList.toggle("hide", v!=="home");
  $("viewExam").classList.toggle("hide", v!=="exam");
  $("viewResult").classList.toggle("hide", v!=="result");
  $("viewBank").classList.toggle("hide", v!=="bank");
}

function renderExam(){
  const qid = exam.items[exam.index];
  const q = getQ(qid);
  if(!q){ alert("Quest√£o n√£o encontrada."); return; }

  $("examIndex").textContent = exam.index+1;
  $("examTotal").textContent = exam.items.length;

  $("qTitle").textContent = `Quest√£o ${exam.index+1}`;
  $("qMeta").textContent = `${q.theme} ‚Ä¢ ${labelDiff(q.diff)} ‚Ä¢ ID: ${q.id}`;
  $("qText").textContent = q.text;

  $("qTags").innerHTML = (q.tags||[]).slice(0,3).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");

  const saved = exam.answers[qid]?.choice || "";
  $("qOptions").innerHTML = q.options.map((opt, idx)=>{
    const letter = String.fromCharCode(65+idx);
    const checked = (saved===letter) ? "checked" : "";
    const clean = opt.replace(/^[A-E]\)\s*/,"");
    return `
      <label class="opt">
        <input type="radio" name="opt" value="${letter}" ${checked} />
        <div>
          <div style="font-family:var(--mono)"><b>${letter}</b></div>
          <div class="optText">${escapeHtml(clean)}</div>
        </div>
      </label>
    `;
  }).join("");

  // limpar explica√ß√£o a cada render
  $("qExplain").classList.remove("show");
  $("qExplain").textContent = "";

  updateAnswerStatus();

  const flagged = !!exam.answers[qid]?.flagged;
  $("btnFlag").textContent = flagged ? "Desmarcar" : "Marcar";

  document.querySelectorAll('input[name="opt"]').forEach(r=>{
    r.addEventListener("change", (e)=>{
      const choice = e.target.value;
      if(!exam.answers[qid]) exam.answers[qid] = {choice:"", flagged:false, counted:false};
      exam.answers[qid].choice = choice;
      persist();
      renderExamMap();
      updateAnswerStatus();

      // Checagem imediata (do jeito que tu pediu)
      const correct = q.answer.toUpperCase();
      const ok = (choice === correct);

      // Sempre registra hist√≥rico (1x) quando responde
      if(!exam.answers[qid].counted){
        applyStats(q.theme, ok);
        exam.answers[qid].counted = true;
        persist();
        applyFilters(false);
      }

      // Mostrar coment√°rio:
      // - se cfg.explainMode==="always" mostra sempre
      // - se "wrong" mostra s√≥ quando errar
      if(cfg.explainMode === "always" || (!ok && cfg.explainMode==="wrong")){
        showExplain(q, choice, ok);
      } else {
        // se acertou e modo errado-only: s√≥ feedback curto
        $("qExplain").classList.remove("show");
        $("qExplain").textContent = "";
      }
    });
  });

  $("btnPrev").disabled = exam.index===0;
  $("btnNext").disabled = exam.index===exam.items.length-1;
}

function showExplain(q, choice, ok){
  const correct = q.answer.toUpperCase();
  $("qExplain").classList.add("show");
  $("qExplain").textContent =
`Gabarito: ${correct}
Sua resposta: ${choice}
Resultado: ${ok ? "‚úÖ ACERTOU" : "‚ùå ERROU"}

Coment√°rio:
${q.explain || "Sem coment√°rio cadastrado."}

Dica r√°pida:
${ok ? "Boa. Segue o baile." : "Errou? Perfeito ‚Äî √© aqui que teu c√©rebro aprende de verdade."}`;
}

function updateAnswerStatus(){
  const qid = exam.items[exam.index];
  const saved = exam.answers[qid]?.choice || "";
  const flagged = !!exam.answers[qid]?.flagged;
  $("answerStatus").textContent = saved ? `Respondida: ${saved} ${flagged?"‚Ä¢ ‚ú≥":""}` : (flagged ? "Sem resposta ‚Ä¢ ‚ú≥" : "Sem resposta");
}

function toggleFlag(){
  const qid = exam.items[exam.index];
  if(!exam.answers[qid]) exam.answers[qid] = {choice:"", flagged:false, counted:false};
  exam.answers[qid].flagged = !exam.answers[qid].flagged;
  persist();
  renderExamMap();
  renderExam();
}

function gotoIndex(i){
  if(i<0 || i>=exam.items.length) return;
  exam.index = i;
  persist();
  renderExam();
  renderExamMap();
}

function renderExamMap(){
  const box = $("examMap");
  box.innerHTML = "";
  exam.items.forEach((qid, idx)=>{
    const a = exam.answers[qid]?.choice;
    const flagged = !!exam.answers[qid]?.flagged;

    let cls = "badge";
    if(flagged) cls = "badge warn";
    else if(a) cls = "badge good";

    const el = document.createElement("button");
    el.className = cls;
    el.textContent = flagged ? `${idx+1} ‚ú≥` : `${idx+1}${a? " ‚úì":""}`;
    el.onclick = ()=>gotoIndex(idx);
    box.appendChild(el);
  });
}

function finishExam(timeUp=false){
  endTimer();
  let correct=0, wrong=0, blank=0;

  exam.items.forEach(qid=>{
    const q = getQ(qid);
    const choice = exam.answers[qid]?.choice || "";
    if(!choice){ blank++; return; }
    const ok = (choice === q.answer.toUpperCase());
    if(ok) correct++; else wrong++;
  });

  const total = exam.items.length;
  const answered = correct + wrong;
  const acc = answered ? Math.round((correct/answered)*100) : 0;

  $("resultSummary").textContent =
`Total: ${total}
Respondidas: ${answered}
Em branco: ${blank}
Acertos: ${correct}
Erros: ${wrong}
Acur√°cia (sobre respondidas): ${acc}%` + (timeUp ? "\n\n‚è∞ Tempo esgotou." : "");

  $("resultStatus").textContent = (acc>=70) ? "T√° ficando perigoso. Mant√©m o ritmo." : "Agora √© caderno de erros + repeti√ß√£o por tema.";

  renderResultList();
  showView("result");
  persist();
}

function renderResultList(){
  const box = $("resultList");
  box.innerHTML = "";
  exam.items.forEach((qid, idx)=>{
    const q = getQ(qid);
    const choice = exam.answers[qid]?.choice || "";
    const ok = choice ? (choice===q.answer.toUpperCase()) : false;

    const div = document.createElement("div");
    div.className = "card";
    div.style.marginTop = "10px";

    const badgeCls = choice ? (ok ? "badge good" : "badge bad") : "badge warn";
    const badgeTxt = choice ? (ok ? "Acertou" : "Errou") : "Em branco";

    div.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">${idx+1}. ${escapeHtml(q.theme)} ‚Ä¢ ${escapeHtml(q.id)}</div>
          <div class="small">${escapeHtml(q.text.slice(0,140))}${q.text.length>140?"‚Ä¶":""}</div>
        </div>
        <div class="${badgeCls}">${badgeTxt}</div>
      </div>
      <div class="hr"></div>
      <div class="small" style="margin-bottom:6px">Gabarito: <b>${q.answer}</b> ‚Ä¢ Sua resposta: <b>${choice||"‚Äî"}</b></div>
      <div class="qtext" style="font-size:14px">${escapeHtml(q.explain || "Sem coment√°rio cadastrado.")}</div>
      <div class="row" style="margin-top:10px">
        <button class="primary" data-open="${escapeHtml(qid)}">Abrir no simulado</button>
      </div>
    `;
    div.querySelector("button[data-open]").onclick = ()=>{
      showView("exam");
      exam.index = idx;
      persist();
      renderExam();
      renderExamMap();
      // abre coment√°rio ao entrar pelo caderno
      const q2 = getQ(qid);
      const ch = exam.answers[qid]?.choice || "";
      const ok2 = ch && (ch === q2.answer.toUpperCase());
      showExplain(q2, ch||"‚Äî", ok2);
    };
    box.appendChild(div);
  });
}

/* ============ TIMER ============ */
function startTimer(){
  endTimer();
  if(!exam.active || exam.timeLimitSec<=0){
    $("timer").textContent = "‚è± livre";
    return;
  }
  exam.timerId = setInterval(()=>{
    const elapsed = Math.floor((Date.now()-exam.startedAt)/1000);
    exam.durationSec = elapsed;
    const remaining = Math.max(0, exam.timeLimitSec - elapsed);
    $("timer").textContent = "‚è± " + formatTime(remaining);
    if(remaining<=0){
      endTimer();
      finishExam(true);
    }
    persist();
  }, 500);
}
function endTimer(){
  if(exam.timerId){ clearInterval(exam.timerId); exam.timerId=null; }
}
function formatTime(sec){
  const m=Math.floor(sec/60), s=sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}

/* ============ STATS / ERROS ============ */
function applyStats(theme, ok){
  stats.answered++;
  if(ok) stats.correct++; else stats.wrong++;

  if(!stats.byTheme[theme]) stats.byTheme[theme] = {answered:0, correct:0, wrong:0};
  stats.byTheme[theme].answered++;
  if(ok) stats.byTheme[theme].correct++; else stats.byTheme[theme].wrong++;

  // caderno de erros (persistente)
  // guarda IDs erradas pra voc√™ revisar depois
  // (se acertar depois, a gente mant√©m at√© voc√™ querer limpar ‚Äî estrat√©gia boa de estudo)
  persist();
}

function renderTopicStats(){
  const box = $("topicStats");
  const entries = Object.entries(stats.byTheme||{});
  if(entries.length===0){
    box.textContent = "Ainda sem hist√≥rico. Faz um simulado.";
    return;
  }
  // ordena por mais respondidas
  entries.sort((a,b)=>b[1].answered-a[1].answered);

  box.innerHTML = "";
  entries.slice(0,12).forEach(([t,v])=>{
    const rate = v.answered ? Math.round((v.correct/v.answered)*100) : 0;
    const badge = (rate>=70) ? "badge good" : (rate<50 ? "badge bad" : "badge warn");
    const line = document.createElement("div");
    line.className = "row";
    line.style.justifyContent = "space-between";
    line.style.alignItems = "center";
    line.style.margin = "8px 0";
    line.innerHTML = `
      <div>
        <div style="font-weight:900">${escapeHtml(t)}</div>
        <div class="small">${v.correct} acertos ‚Ä¢ ${v.wrong} erros ‚Ä¢ ${v.answered} total</div>
      </div>
      <div class="${badge}">${rate}%</div>
    `;
    box.appendChild(line);
  });
}

/* ============ CADERNO DE ERROS ============ */
function startErrorsNotebook(){
  // monta lista de quest√µes que voc√™ errou nesta sess√£o (e/ou hist√≥rico simples)
  // aqui vamos usar: "errou nesta sess√£o" (mais seguro e imediato)
  const wrongIds = exam.items.filter(qid=>{
    const q = getQ(qid);
    const ch = exam.answers[qid]?.choice || "";
    if(!ch) return false;
    return ch !== q.answer.toUpperCase();
  });

  if(wrongIds.length===0){
    alert("Nenhuma errada nesta prova üòÖ. Faz outra com tema mais dif√≠cil.");
    return;
  }

  exam.active = true;
  exam.items = wrongIds;
  exam.answers = {}; // reset respostas pra revisar de verdade
  exam.index = 0;
  exam.startedAt = Date.now();
  exam.durationSec = 0;
  exam.timeLimitSec = 0; // livre

  persist();
  showView("exam");
  renderExam();
  startTimer();
  renderExamMap();
}

/* ============ BANCO VIEW ============ */
function renderBankView(){
  const box = $("bankList");
  box.innerHTML = "";
  bank.forEach((q, i)=>{
    const div = document.createElement("div");
    div.className = "card";
    div.style.marginTop = "10px";
    div.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">${i+1}. ${escapeHtml(q.id)} ‚Ä¢ ${escapeHtml(q.theme)} ‚Ä¢ ${labelDiff(q.diff)}</div>
          <div class="small">${escapeHtml(q.text)}</div>
        </div>
        <div class="badge">${escapeHtml(q.answer)}</div>
      </div>
      <div class="hr"></div>
      <div class="qtext" style="font-size:14px">${escapeHtml(q.explain || "Sem coment√°rio")}</div>
    `;
    box.appendChild(div);
  });
}

/* ============ RESET ============ */
function resetAll(){
  if(!confirm("Reset total (hist√≥rico + sess√£o)?")) return;
  cfg = {...DEFAULT_CFG};
  stats = {...DEFAULT_STATS};
  bank = buildBank100();
  exam = {active:false, items:[], answers:{}, index:0, startedAt:null, durationSec:0, timerId:null, timeLimitSec:0};
  persist();
  rebuildThemeFilter();
  applyFilters();
  showView("home");
}

/* ============ WIRE UI ============ */
function wire(){
  rebuildThemeFilter();
  applyFilters();

  // config explain mode
  setExplainMode(cfg.explainMode || "wrong");
  $("cfgWrongExplain").onclick = ()=>setExplainMode("wrong");
  $("cfgAlwaysExplain").onclick = ()=>setExplainMode("always");

  $("btnApply").onclick = ()=>applyFilters(false);
  $("btnShuffle").onclick = ()=>applyFilters(true);

  $("qSearch").addEventListener("input", ()=>applyFilters(false));
  $("qTheme").addEventListener("change", ()=>applyFilters(false));
  $("qDiff").addEventListener("change", ()=>applyFilters(false));

  $("btnStart").onclick = ()=>startExamFromFilters();
  $("btnFinish").onclick = ()=>finishExam(false);
  $("btnPrev").onclick = ()=>gotoIndex(exam.index-1);
  $("btnNext").onclick = ()=>gotoIndex(exam.index+1);
  $("btnFlag").onclick = ()=>toggleFlag();

  $("btnNew").onclick = ()=>{
    endTimer();
    exam = {active:false, items:[], answers:{}, index:0, startedAt:null, durationSec:0, timerId:null, timeLimitSec:0};
    persist();
    showView("home");
  };
  $("btnReviewErrors").onclick = ()=>startErrorsNotebook();

  $("btnErrors").onclick = ()=>{
    if(!exam.active){
      alert("Primeiro faz uma prova. Depois eu monto o caderno de erros dela.");
      return;
    }
    startErrorsNotebook();
  };

  $("btnBank").onclick = ()=>{
    renderBankView();
    showView("bank");
  };

  $("btnReset").onclick = ()=>resetAll();

  // Se havia sess√£o ativa, volta direto
  if(exam.active && exam.items?.length){
    showView("exam");
    renderExam();
    startTimer();
    renderExamMap();
  } else {
    showView("home");
  }
}
wire();
</script>
</body>
</html>
